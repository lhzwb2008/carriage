<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¿è´¹é¢„æµ‹ç³»ç»Ÿ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg-dark: #0f1419;
            --bg-card: #1a1f26;
            --bg-input: #252b33;
            --accent: #00d4aa;
            --accent-glow: rgba(0, 212, 170, 0.2);
            --warning: #f59e0b;
            --text-primary: #e7e9ea;
            --text-secondary: #71767b;
            --border: #2f3336;
            --success: #00ba7c;
            --predict-color: #8b5cf6;
        }

        body {
            font-family: 'Noto Sans SC', -apple-system, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        h1 {
            font-size: 1.6rem;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--accent);
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .stats-bar {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 12px;
            font-size: 0.8rem;
        }

        .stat-item { color: var(--text-secondary); }
        .stat-item span { color: var(--accent); font-weight: 500; }

        /* Tab */
        .tabs {
            display: flex;
            gap: 0;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 0.9rem;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab:hover { color: var(--text-primary); }
        .tab.active { color: var(--accent); border-bottom-color: var(--accent); }

        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Card */
        .card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 25px;
            border: 1px solid var(--border);
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 0.95rem;
            font-weight: 500;
            margin-bottom: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Form */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group { margin-bottom: 15px; }

        label {
            display: block;
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        select, input {
            width: 100%;
            padding: 12px 14px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
            font-family: inherit;
            transition: all 0.2s;
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px var(--accent-glow);
        }

        select option { background: var(--bg-input); }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .btn-primary {
            background: var(--accent);
            color: #000;
            width: 100%;
        }

        .btn-primary:hover {
            background: #00e6b8;
            transform: translateY(-1px);
        }

        /* Result */
        .result-box {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, rgba(0, 212, 170, 0.1), rgba(139, 92, 246, 0.05));
            border: 1px solid rgba(0, 212, 170, 0.3);
            border-radius: 10px;
        }

        .result-box.show { display: block; }

        .result-route {
            font-size: 1.05rem;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .result-route .arrow { color: var(--accent); }

        .result-distance {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 15px;
        }

        .result-price {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--accent);
        }

        .result-price .unit {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-left: 5px;
        }

        .result-meta {
            margin-top: 12px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .badge-predict { background: rgba(139, 92, 246, 0.2); color: var(--predict-color); }
        .badge-history { background: rgba(0, 186, 124, 0.2); color: var(--success); }
        .badge-today { background: rgba(245, 158, 11, 0.2); color: var(--warning); }

        /* Today list */
        .today-list { max-height: 350px; overflow-y: auto; }

        .today-item {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
            align-items: center;
            font-size: 0.85rem;
        }

        .today-item:last-child { border-bottom: none; }
        .today-route { color: var(--text-primary); }
        .today-vehicle { color: var(--text-secondary); font-size: 0.8rem; }
        .today-price { color: var(--warning); font-weight: 600; text-align: right; }
        .today-time { color: var(--text-secondary); font-size: 0.75rem; }

        .empty-state {
            text-align: center;
            padding: 35px;
            color: var(--text-secondary);
        }

        .empty-icon { font-size: 1.8rem; margin-bottom: 8px; opacity: 0.5; }

        /* Messages */
        .error-box {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #f87171;
            padding: 10px 14px;
            border-radius: 8px;
            margin-top: 12px;
            font-size: 0.85rem;
        }

        .success-box {
            background: rgba(0, 186, 124, 0.1);
            border: 1px solid rgba(0, 186, 124, 0.3);
            color: var(--success);
            padding: 10px 14px;
            border-radius: 8px;
            margin-top: 12px;
            font-size: 0.85rem;
        }

        /* City option styling */
        .city-history { color: var(--success); }
        .city-predict { color: var(--predict-color); }

        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: var(--bg-input); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

        @media (max-width: 600px) {
            .form-row { grid-template-columns: 1fr; }
            .today-item { grid-template-columns: 1fr 1fr; }
            .today-vehicle, .today-time { display: none; }
            .stats-bar { flex-wrap: wrap; gap: 10px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸš› è¿è´¹é¢„æµ‹ç³»ç»Ÿ</h1>
            <p class="subtitle">åŸºäºå†å²æ•°æ®çš„æ™ºèƒ½è¿è¾“è´¹ç”¨é¢„æµ‹</p>
            <div class="stats-bar">
                <div class="stat-item">å†å²æ•°æ® <span id="excelCount">-</span> æ¡</div>
                <div class="stat-item">ä»Šæ—¥å½•å…¥ <span id="todayCount">-</span> æ¡</div>
                <div class="stat-item">æ”¯æŒåŸå¸‚ <span id="cityCount">-</span> ä¸ª</div>
            </div>
        </header>

        <div class="tabs">
            <div class="tab active" data-tab="predict">ğŸ“Š è¿è´¹é¢„æµ‹</div>
            <div class="tab" data-tab="input">âœï¸ å½•å…¥æ•°æ®</div>
            <div class="tab" data-tab="today">ğŸ“‹ ä»Šæ—¥è®°å½•</div>
        </div>

        <!-- é¢„æµ‹é¢æ¿ -->
        <div id="predict-panel" class="tab-content active">
            <div class="card">
                <div class="card-title">é€‰æ‹©è·¯çº¿å’Œè½¦å‹</div>
                <div class="form-row">
                    <div class="form-group">
                        <label>å‡ºå‘åœ°</label>
                        <select id="fromCity"></select>
                    </div>
                    <div class="form-group">
                        <label>ç›®çš„åœ°</label>
                        <select id="toCity"></select>
                    </div>
                </div>
                <div class="form-group">
                    <label>è½¦å‹</label>
                    <select id="vehicleType">
                        <option value="é€šç”¨">é€šç”¨ï¼ˆæ‰€æœ‰è½¦å‹å¹³å‡ï¼‰</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="predict()">é¢„æµ‹è¿è´¹</button>
                
                <div id="predictResult" class="result-box">
                    <div class="result-route">
                        <span id="resultFrom"></span>
                        <span class="arrow">â†’</span>
                        <span id="resultTo"></span>
                        <span id="resultBadge" class="badge"></span>
                    </div>
                    <div class="result-distance" id="resultDistance"></div>
                    <div class="result-price">
                        Â¥<span id="resultPrice"></span>
                        <span class="unit">å…ƒ</span>
                    </div>
                    <div class="result-meta" id="resultMeta"></div>
                </div>
                <div id="predictError" class="error-box" style="display:none;"></div>
            </div>
        </div>

        <!-- å½•å…¥é¢æ¿ -->
        <div id="input-panel" class="tab-content">
            <div class="card">
                <div class="card-title">ğŸ“ å½•å…¥ä»Šæ—¥è¿è´¹æ•°æ®</div>
                <p style="color: var(--text-secondary); font-size: 0.8rem; margin-bottom: 15px;">
                    å½•å…¥çš„æ•°æ®å°†ç”¨äºä¼˜åŒ–é¢„æµ‹æ¨¡å‹ï¼Œä»Šæ—¥æ•°æ®æƒé‡æ›´é«˜
                </p>
                <div class="form-row">
                    <div class="form-group">
                        <label>å‡ºå‘åœ°</label>
                        <select id="inputFromCity"></select>
                    </div>
                    <div class="form-group">
                        <label>ç›®çš„åœ°</label>
                        <select id="inputToCity"></select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>è½¦å‹</label>
                        <select id="inputVehicle">
                            <option value="">è¯·é€‰æ‹©è½¦å‹</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>è¿è´¹ï¼ˆå…ƒï¼‰</label>
                        <input type="number" id="inputPrice" placeholder="è¯·è¾“å…¥è¿è´¹é‡‘é¢" min="0" step="0.01">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="addRecord()">ä¿å­˜è®°å½•</button>
                <div id="inputSuccess" class="success-box" style="display:none;"></div>
                <div id="inputError" class="error-box" style="display:none;"></div>
            </div>
        </div>

        <!-- ä»Šæ—¥è®°å½•é¢æ¿ -->
        <div id="today-panel" class="tab-content">
            <div class="card">
                <div class="card-title">
                    <span>ğŸ“‹ ä»Šæ—¥å½•å…¥è®°å½•</span>
                    <span class="badge badge-today" id="todayBadge">0 æ¡</span>
                </div>
                <div class="today-list" id="todayList">
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“­</div>
                        <div>ä»Šæ—¥æš‚æ— å½•å…¥æ•°æ®</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let citiesData = [];
        let vehicleTypes = [];

        // è®¡ç®—ä¸¤ç‚¹ä¹‹é—´çš„è·ç¦»ï¼ˆHaversineå…¬å¼ï¼‰
        function calcDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // åœ°çƒåŠå¾„ï¼ˆå…¬é‡Œï¼‰
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return Math.round(R * c);
        }

        // è·å–åŸå¸‚åæ ‡
        function getCityCoords(cityName) {
            const city = citiesData.find(c => c.name === cityName);
            return city ? { lat: city.lat, lng: city.lng } : null;
        }

        async function init() {
            await Promise.all([
                loadStats(),
                loadCities(),
                loadVehicles(),
                loadTodayData()
            ]);
            
            // å‡ºå‘åœ°å˜åŒ–æ—¶æ›´æ–°ç›®çš„åœ°æ˜¾ç¤º
            document.getElementById('fromCity').addEventListener('change', () => updateDestOptions('toCity', 'fromCity'));
            document.getElementById('inputFromCity').addEventListener('change', () => updateDestOptions('inputToCity', 'inputFromCity'));
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(tab.dataset.tab + '-panel').classList.add('active');
                    if (tab.dataset.tab === 'today') loadTodayData();
                });
            });
        }

        async function loadStats() {
            const res = await fetch('/api/stats');
            const data = await res.json();
            document.getElementById('excelCount').textContent = data.total_excel.toLocaleString();
            document.getElementById('todayCount').textContent = data.today_manual;
            document.getElementById('cityCount').textContent = data.cities_count;
        }

        async function loadCities() {
            const res = await fetch('/api/cities');
            const data = await res.json();
            citiesData = data.cities;
            
            // å¡«å……å‡ºå‘åœ°ä¸‹æ‹‰æ¡†ï¼ˆä¸æ˜¾ç¤ºè·ç¦»ï¼‰
            ['fromCity', 'inputFromCity'].forEach(id => {
                const select = document.getElementById(id);
                select.innerHTML = '';
                citiesData.forEach(city => {
                    const option = document.createElement('option');
                    option.value = city.name;
                    let label = city.name;
                    if (city.is_origin) label += ' ğŸ“';
                    else if (city.has_history) label += ' âœ“';
                    else label += ' â­';
                    option.textContent = label;
                    select.appendChild(option);
                });
            });
            
            // é»˜è®¤é€‰æ‹©éœå°”æœæ–¯
            document.getElementById('fromCity').value = 'éœå°”æœæ–¯';
            document.getElementById('inputFromCity').value = 'éœå°”æœæ–¯';
            
            // å¡«å……ç›®çš„åœ°ï¼ˆæ ¹æ®å‡ºå‘åœ°è®¡ç®—è·ç¦»ï¼‰
            updateDestOptions('toCity', 'fromCity');
            updateDestOptions('inputToCity', 'inputFromCity');
        }
        
        // æ›´æ–°ç›®çš„åœ°é€‰é¡¹ï¼ˆæ ¹æ®å‡ºå‘åœ°åŠ¨æ€è®¡ç®—è·ç¦»ï¼‰
        function updateDestOptions(destSelectId, fromSelectId) {
            const fromCity = document.getElementById(fromSelectId).value;
            const fromCoords = getCityCoords(fromCity);
            const select = document.getElementById(destSelectId);
            const currentValue = select.value;
            
            // è®¡ç®—æ¯ä¸ªåŸå¸‚åˆ°å‡ºå‘åœ°çš„è·ç¦»
            let options = citiesData.map(city => {
                let dist = 0;
                if (fromCoords && city.name !== fromCity) {
                    dist = calcDistance(fromCoords.lat, fromCoords.lng, city.lat, city.lng);
                }
                return { ...city, distance: dist };
            });
            
            // æŒ‰è·ç¦»æ’åºï¼ˆå‡ºå‘åœ°æ’ç¬¬ä¸€ï¼Œè·ç¦»0çš„æ’å‰é¢ï¼‰
            options.sort((a, b) => {
                if (a.name === fromCity) return -1;
                if (b.name === fromCity) return 1;
                return a.distance - b.distance;
            });
            
            // é‡æ–°å¡«å……é€‰é¡¹
            select.innerHTML = '';
            options.forEach(city => {
                const option = document.createElement('option');
                option.value = city.name;
                
                let label = city.name;
                if (city.name !== fromCity && city.distance > 0) {
                    label += ` (${city.distance}km)`;
                }
                
                if (city.is_origin) label += ' ğŸ“';
                else if (city.has_history) label += ' âœ“';
                else label += ' â­';
                
                option.textContent = label;
                select.appendChild(option);
            });
            
            // æ¢å¤ä¹‹å‰çš„é€‰æ‹©ï¼Œæˆ–é€‰æ‹©ç¬¬ä¸€ä¸ªéå‡ºå‘åœ°åŸå¸‚
            if (currentValue && currentValue !== fromCity) {
                select.value = currentValue;
            } else {
                const firstDest = options.find(c => c.name !== fromCity);
                if (firstDest) select.value = firstDest.name;
            }
        }

        async function loadVehicles() {
            const res = await fetch('/api/vehicles');
            vehicleTypes = await res.json();
            
            const selects = ['vehicleType', 'inputVehicle'];
            selects.forEach(id => {
                const select = document.getElementById(id);
                const isPredict = id === 'vehicleType';
                select.innerHTML = isPredict ? '<option value="é€šç”¨">é€šç”¨ï¼ˆæ‰€æœ‰è½¦å‹å¹³å‡ï¼‰</option>' : '<option value="">è¯·é€‰æ‹©è½¦å‹</option>';
                
                vehicleTypes.forEach(v => {
                    if (v !== 'é€šç”¨') {
                        select.innerHTML += `<option value="${v}">${v}</option>`;
                    }
                });
            });
        }

        async function loadTodayData() {
            const res = await fetch('/api/today');
            const data = await res.json();
            
            document.getElementById('todayBadge').textContent = data.count + ' æ¡';
            document.getElementById('todayCount').textContent = data.count;
            
            const container = document.getElementById('todayList');
            
            if (data.records.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“­</div>
                        <div>ä»Šæ—¥æš‚æ— å½•å…¥æ•°æ®</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = data.records.map(r => `
                <div class="today-item">
                    <div class="today-route">${r.from_city} â†’ ${r.to_city}</div>
                    <div class="today-vehicle">${r.vehicle}</div>
                    <div class="today-price">Â¥${Number(r.price).toLocaleString()}</div>
                    <div class="today-time">${r.time}</div>
                </div>
            `).join('');
        }

        async function predict() {
            const fromCity = document.getElementById('fromCity').value;
            const toCity = document.getElementById('toCity').value;
            const vehicle = document.getElementById('vehicleType').value;
            
            hideMessages('predict');
            
            if (!fromCity || !toCity) {
                showError('predict', 'è¯·é€‰æ‹©å‡ºå‘åœ°å’Œç›®çš„åœ°');
                return;
            }
            
            if (fromCity === toCity) {
                showError('predict', 'å‡ºå‘åœ°å’Œç›®çš„åœ°ä¸èƒ½ç›¸åŒ');
                return;
            }
            
            const res = await fetch('/api/predict', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ from_city: fromCity, to_city: toCity, vehicle })
            });
            
            const data = await res.json();
            
            if (data.error) {
                showError('predict', data.error);
                return;
            }
            
            document.getElementById('resultFrom').textContent = data.from_city;
            document.getElementById('resultTo').textContent = data.to_city;
            document.getElementById('resultDistance').textContent = `è·ç¦»ï¼š${data.distance} å…¬é‡Œ`;
            document.getElementById('resultPrice').textContent = Number(data.price).toLocaleString();
            document.getElementById('resultMeta').textContent = `è½¦å‹ï¼š${data.vehicle}`;
            
            const badge = document.getElementById('resultBadge');
            if (data.is_prediction) {
                badge.textContent = 'é¢„æµ‹å€¼';
                badge.className = 'badge badge-predict';
            } else {
                badge.textContent = 'æœ‰å†å²æ•°æ®';
                badge.className = 'badge badge-history';
            }
            
            document.getElementById('predictResult').classList.add('show');
        }

        async function addRecord() {
            const fromCity = document.getElementById('inputFromCity').value;
            const toCity = document.getElementById('inputToCity').value;
            const vehicle = document.getElementById('inputVehicle').value;
            const price = document.getElementById('inputPrice').value;
            
            hideMessages('input');
            
            if (!fromCity || !toCity || !vehicle || !price) {
                showError('input', 'è¯·å¡«å†™æ‰€æœ‰å­—æ®µ');
                return;
            }
            
            if (fromCity === toCity) {
                showError('input', 'å‡ºå‘åœ°å’Œç›®çš„åœ°ä¸èƒ½ç›¸åŒ');
                return;
            }
            
            const res = await fetch('/api/add_record', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ from_city: fromCity, to_city: toCity, vehicle, price })
            });
            
            const data = await res.json();
            
            if (data.error) {
                showError('input', data.error);
                return;
            }
            
            showSuccess('input', `å·²ä¿å­˜ï¼š${fromCity} â†’ ${toCity}ï¼ŒÂ¥${Number(price).toLocaleString()}`);
            document.getElementById('inputPrice').value = '';
            loadStats();
        }

        function showError(panel, msg) {
            const el = document.getElementById(panel + 'Error');
            el.textContent = msg;
            el.style.display = 'block';
        }

        function showSuccess(panel, msg) {
            const el = document.getElementById(panel + 'Success');
            el.textContent = msg;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 3000);
        }

        function hideMessages(panel) {
            const error = document.getElementById(panel + 'Error');
            const success = document.getElementById(panel + 'Success');
            if (error) error.style.display = 'none';
            if (success) success.style.display = 'none';
            if (panel === 'predict') {
                document.getElementById('predictResult').classList.remove('show');
            }
        }

        init();
    </script>
</body>
</html>
